# H∆∞·ªõng d·∫´n Ch·ª©c nƒÉng C·∫≠p nh·∫≠t Chi ph√≠ Th·ª±c t·∫ø

## üéØ **T√¨nh tr·∫°ng: HO√ÄN TH√ÄNH**

ƒê√£ th√™m ch·ª©c nƒÉng c·∫≠p nh·∫≠t chi ph√≠ th·ª±c t·∫ø ƒë√£ c√≥ v·ªõi UI ƒë·ªÉ ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t.

## ‚ú® **C√°c thay ƒë·ªïi ch√≠nh:**

### **1. State Management**
```jsx
// State for updating existing expenses
const [existingExpenses, setExistingExpenses] = useState<any[]>([])
const [selectedExpenseToUpdate, setSelectedExpenseToUpdate] = useState<any>(null)
const [showExpenseSelector, setShowExpenseSelector] = useState(false)
```

**C·∫£i thi·ªán:**
- ‚úÖ State ƒë·ªÉ qu·∫£n l√Ω existing expenses
- ‚úÖ State ƒë·ªÉ ch·ªçn expense c·∫ßn c·∫≠p nh·∫≠t
- ‚úÖ State ƒë·ªÉ hi·ªÉn th·ªã expense selector modal

### **2. Load Existing Expenses**
```jsx
const loadExistingExpenses = async () => {
  try {
    console.log('üîç Loading existing expenses...')
    
    const { data: expenses, error } = await supabase
      .from('project_expenses')
      .select(`
        id,
        description,
        amount,
        expense_date,
        status,
        expense_object_id,
        id_parent,
        created_at,
        expense_objects!inner(name, parent_id)
      `)
      .eq('status', 'approved')
      .is('id_parent', null) // Only parent expenses
      .order('created_at', { ascending: false })
    
    if (error) {
      console.error('‚ùå Error loading existing expenses:', error)
      return
    }
    
    console.log('üìä Loaded existing expenses:', expenses)
    setExistingExpenses(expenses || [])
    
  } catch (error) {
    console.error('‚ùå Error loading existing expenses:', error)
  }
}
```

**C·∫£i thi·ªán:**
- ‚úÖ Load existing parent expenses
- ‚úÖ Filter by approved status
- ‚úÖ Order by creation date
- ‚úÖ Include expense object details

### **3. Load Expense Data for Update**
```jsx
const loadExpenseDataForUpdate = async (expense: any) => {
  try {
    console.log('üîç Loading expense data for update:', expense)
    
    // Load child expenses
    const { data: childExpenses, error: childError } = await supabase
      .from('project_expenses')
      .select(`
        id,
        description,
        amount,
        expense_object_id,
        expense_objects!inner(name)
      `)
      .eq('id_parent', expense.id)
    
    if (childError) {
      console.error('‚ùå Error loading child expenses:', childError)
      return
    }
    
    console.log('üìä Loaded child expenses:', childExpenses)
    
    // Populate form with expense data
    setFormData({
      project_id: expense.project_id || '',
      description: expense.description || '',
      actual_amount: expense.amount || 0,
      currency: expense.currency || 'VND',
      expense_date: expense.expense_date || '',
      employee_id: expense.employee_id || '',
      notes: expense.notes || '',
      category: 'actual',
      status: 'approved',
      receipt_url: '',
      id_parent: '',
      expense_object_id: '',
      planned_amount: 0
    })
    
    // Set selected expense objects
    const expenseObjectIds = childExpenses?.map(child => child.expense_object_id) || []
    setSelectedExpenseObjectIds(expenseObjectIds)
    
    // Calculate direct object totals from child expenses
    const directTotals: Record<string, number> = {}
    childExpenses?.forEach(child => {
      if (child.expense_object_id) {
        directTotals[child.expense_object_id] = child.amount || 0
      }
    })
    setDirectObjectTotals(directTotals)
    
    console.log('‚úÖ Expense data loaded for update:', {
      formData: formData,
      selectedExpenseObjectIds: expenseObjectIds,
      directObjectTotals: directTotals
    })
    
  } catch (error) {
    console.error('‚ùå Error loading expense data for update:', error)
  }
}
```

**C·∫£i thi·ªán:**
- ‚úÖ Load child expenses
- ‚úÖ Populate form data
- ‚úÖ Set selected expense objects
- ‚úÖ Calculate direct object totals

### **4. Update Existing Expense**
```jsx
const updateExistingExpense = async (expense: any) => {
  try {
    console.log('üîÑ Updating existing expense:', expense.id)
    setSubmitting(true)
    
    // Calculate total amount from direct object totals
    const totalAmount = Object.values(directObjectTotals).reduce((sum, amount) => sum + (amount || 0), 0)
    
    if (totalAmount <= 0) {
      console.error('‚ùå Total amount must be greater than 0')
      return
    }
    
    // Update parent expense
    const { error: parentError } = await supabase
      .from('project_expenses')
      .update({
        description: formData.description,
        amount: totalAmount,
        currency: formData.currency,
        expense_date: formData.expense_date,
        updated_at: new Date().toISOString()
      })
      .eq('id', expense.id)
    
    if (parentError) {
      console.error('‚ùå Error updating parent expense:', parentError)
      return
    }
    
    console.log('‚úÖ Updated parent expense')
    
    // Delete existing child expenses
    const { error: deleteError } = await supabase
      .from('project_expenses')
      .delete()
      .eq('id_parent', expense.id)
    
    if (deleteError) {
      console.error('‚ùå Error deleting child expenses:', deleteError)
      return
    }
    
    console.log('‚úÖ Deleted existing child expenses')
    
    // Create new child expenses
    for (const [childObjectId, amountValue] of Object.entries(directObjectTotals)) {
      if (amountValue <= 0) {
        console.log('‚ö†Ô∏è Skipping child with zero amount:', childObjectId)
        continue
      }
      
      const childObjectName = expenseObjectsOptions.find(o => o.id === childObjectId)?.name || 'ƒê·ªëi t∆∞·ª£ng'
      const childExpenseData = {
        id: crypto.randomUUID(),
        project_id: formData.project_id,
        description: `${formData.description} - ${childObjectName}`,
        expense_object_id: childObjectId,
        amount: amountValue,
        currency: formData.currency || 'VND',
        expense_date: formData.expense_date,
        status: 'approved',
        employee_id: formData.employee_id || null,
        id_parent: expense.id, // Link to parent
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        expense_object_columns: [childObjectId],
        invoice_items: []
      }
      
      console.log('üì§ Creating child expense:', childObjectName, 'amount:', amountValue)
      
      const { error: childError } = await supabase
        .from('project_expenses')
        .insert(childExpenseData)
      
      if (childError) {
        console.error('‚ùå Error creating child expense:', childError)
        return
      }
      
      console.log('‚úÖ Created child expense:', childObjectName, 'with amount:', amountValue)
    }
    
    console.log('‚úÖ Updated existing expense successfully')
    
    // Clear selection and close
    setSelectedExpenseToUpdate(null)
    onSuccess()
    onClose()
    resetForm()
    
  } catch (error) {
    console.error('‚ùå Error updating existing expense:', error)
  } finally {
    setSubmitting(false)
  }
}
```

**C·∫£i thi·ªán:**
- ‚úÖ Update parent expense
- ‚úÖ Delete existing child expenses
- ‚úÖ Create new child expenses
- ‚úÖ Maintain parent-child relationship

### **5. UI Components**

#### **Update Button in Header**
```jsx
{/* Update existing expense option */}
{category === 'actual' && (
  <div className="mt-3 flex items-center space-x-3">
    <button
      onClick={() => {
        setShowExpenseSelector(true)
        loadExistingExpenses()
      }}
      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
    >
      üìù C·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥
    </button>
    
    {selectedExpenseToUpdate && (
      <div className="flex items-center space-x-2 text-sm">
        <span className="text-gray-600">ƒêang c·∫≠p nh·∫≠t:</span>
        <span className="font-medium text-blue-600">{selectedExpenseToUpdate.description}</span>
        <button
          onClick={() => setSelectedExpenseToUpdate(null)}
          className="text-red-500 hover:text-red-700"
        >
          ‚úï
        </button>
      </div>
    )}
  </div>
)}
```

#### **Expense Selector Modal**
```jsx
{/* Expense Selector Modal */}
{showExpenseSelector && (
  <div className="fixed inset-0 z-[9999] bg-black bg-opacity-50 flex items-center justify-center">
    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
      <div className="p-6 border-b border-gray-200">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-bold text-gray-900">Ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t</h3>
          <button
            onClick={() => setShowExpenseSelector(false)}
            className="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <X className="h-5 w-5" />
          </button>
        </div>
      </div>
      
      <div className="p-6 max-h-[60vh] overflow-y-auto">
        {existingExpenses.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <AlertCircle className="h-12 w-12 mx-auto mb-4 text-gray-400" />
            <p>Kh√¥ng c√≥ chi ph√≠ n√†o ƒë·ªÉ c·∫≠p nh·∫≠t</p>
          </div>
        ) : (
          <div className="space-y-3">
            {existingExpenses.map((expense) => (
              <div
                key={expense.id}
                onClick={() => {
                  setSelectedExpenseToUpdate(expense)
                  setShowExpenseSelector(false)
                  // Load expense data for editing
                  loadExpenseDataForUpdate(expense)
                }}
                className="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h4 className="font-medium text-gray-900">{expense.description}</h4>
                    <p className="text-sm text-gray-600 mt-1">
                      {expense.expense_objects?.name} ‚Ä¢ {new Date(expense.expense_date).toLocaleDateString('vi-VN')}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-gray-900">
                      {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(expense.amount)}
                    </p>
                    <p className="text-xs text-gray-500">{expense.status}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>
)}
```

**C·∫£i thi·ªán:**
- ‚úÖ Update button in header
- ‚úÖ Selected expense display
- ‚úÖ Expense selector modal
- ‚úÖ Expense list with details

### **6. Handle Submit Logic**
```jsx
const handleSubmit = async () => {
  if (!validateForm()) {
    return
  }

  // Ki·ªÉm tra n·∫øu c√≥ parent object v√† children ƒë∆∞·ª£c ch·ªçn
  console.log('üîç Debug dialog trigger:', { 
    workshopParentObject: workshopParentObject?.name, 
    selectedExpenseObjectIds: selectedExpenseObjectIds.length,
    category,
    userRole,
    selectedExpenseToUpdate: selectedExpenseToUpdate?.id
  })
  
  // Check if updating existing expense
  if (selectedExpenseToUpdate) {
    console.log('üîÑ Updating existing expense:', selectedExpenseToUpdate.id)
    await updateExistingExpense(selectedExpenseToUpdate)
    return
  }
  
  // ... rest of create logic
}
```

**C·∫£i thi·ªán:**
- ‚úÖ Check for update mode
- ‚úÖ Call update function
- ‚úÖ Maintain create logic

## üîç **V·∫•n ƒë·ªÅ ƒë√£ s·ª≠a:**

### **1. Update Existing Expenses**
- **Problem:** Kh√¥ng c√≥ c√°ch ƒë·ªÉ c·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥
- **Cause:** Ch·ªâ c√≥ ch·ª©c nƒÉng t·∫°o m·ªõi
- **Solution:** Th√™m ch·ª©c nƒÉng c·∫≠p nh·∫≠t v·ªõi UI selector

### **2. Data Loading**
- **Problem:** Kh√¥ng load ƒë∆∞·ª£c d·ªØ li·ªáu chi ph√≠ c≈©
- **Cause:** Thi·∫øu function load existing expenses
- **Solution:** Th√™m loadExistingExpenses function

### **3. Form Population**
- **Problem:** Form kh√¥ng ƒë∆∞·ª£c populate v·ªõi d·ªØ li·ªáu c≈©
- **Cause:** Thi·∫øu logic populate form
- **Solution:** Th√™m loadExpenseDataForUpdate function

### **4. Update Logic**
- **Problem:** Kh√¥ng c√≥ logic c·∫≠p nh·∫≠t chi ph√≠
- **Cause:** Thi·∫øu update function
- **Solution:** Th√™m updateExistingExpense function

## üéØ **Gi·∫£i ph√°p:**

### **1. UI/UX Flow**
1. **Update Button:** Hi·ªÉn th·ªã button "C·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥"
2. **Expense Selector:** Modal ƒë·ªÉ ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t
3. **Form Population:** T·ª± ƒë·ªông populate form v·ªõi d·ªØ li·ªáu c≈©
4. **Update Process:** C·∫≠p nh·∫≠t parent v√† child expenses

### **2. Data Management**
1. **Load Existing:** Load danh s√°ch chi ph√≠ ƒë√£ c√≥
2. **Load Details:** Load chi ti·∫øt chi ph√≠ ƒë∆∞·ª£c ch·ªçn
3. **Update Process:** C·∫≠p nh·∫≠t parent v√† t·∫°o l·∫°i child expenses
4. **Data Integrity:** ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu

### **3. User Experience**
1. **Clear Selection:** Hi·ªÉn th·ªã chi ph√≠ ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t
2. **Easy Selection:** D·ªÖ d√†ng ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t
3. **Form Pre-fill:** Form ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn d·ªØ li·ªáu
4. **Smooth Update:** Qu√° tr√¨nh c·∫≠p nh·∫≠t m∆∞·ª£t m√†

## üì± **Workflow m·ªõi:**

### **1. Update Flow**
1. Click "C·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥"
2. Ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t t·ª´ modal
3. Form ƒë∆∞·ª£c populate v·ªõi d·ªØ li·ªáu c≈©
4. Ch·ªânh s·ª≠a th√¥ng tin c·∫ßn thi·∫øt
5. Click "C·∫≠p nh·∫≠t" ƒë·ªÉ l∆∞u

### **2. Data Flow**
1. Load existing expenses
2. Select expense to update
3. Load expense details
4. Populate form
5. Update parent expense
6. Delete old child expenses
7. Create new child expenses

### **3. UI Flow**
1. Update button in header
2. Expense selector modal
3. Selected expense display
4. Form editing
5. Update confirmation

## üöÄ **L·ª£i √≠ch:**

### **1. User Experience**
- **Easy Updates:** D·ªÖ d√†ng c·∫≠p nh·∫≠t chi ph√≠
- **Clear Selection:** R√µ r√†ng chi ph√≠ ƒëang c·∫≠p nh·∫≠t
- **Form Pre-fill:** Form ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn
- **Smooth Process:** Qu√° tr√¨nh m∆∞·ª£t m√†

### **2. Data Management**
- **Data Integrity:** ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn
- **Parent-Child:** Duy tr√¨ m·ªëi quan h·ªá
- **Update History:** L·ªãch s·ª≠ c·∫≠p nh·∫≠t
- **Error Handling:** X·ª≠ l√Ω l·ªói t·ªët

### **3. Functionality**
- **Update Existing:** C·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥
- **Create New:** V·∫´n c√≥ th·ªÉ t·∫°o m·ªõi
- **Flexible:** Linh ho·∫°t trong s·ª≠ d·ª•ng
- **Comprehensive:** ƒê·∫ßy ƒë·ªß ch·ª©c nƒÉng

## üé® **Technical Implementation:**

### **1. State Management**
```jsx
// State for updating existing expenses
const [existingExpenses, setExistingExpenses] = useState<any[]>([])
const [selectedExpenseToUpdate, setSelectedExpenseToUpdate] = useState<any>(null)
const [showExpenseSelector, setShowExpenseSelector] = useState(false)
```

### **2. Data Loading**
```jsx
// Load existing expenses
const loadExistingExpenses = async () => {
  const { data: expenses, error } = await supabase
    .from('project_expenses')
    .select(`
      id, description, amount, expense_date, status,
      expense_object_id, id_parent, created_at,
      expense_objects!inner(name, parent_id)
    `)
    .eq('status', 'approved')
    .is('id_parent', null)
    .order('created_at', { ascending: false })
  
  setExistingExpenses(expenses || [])
}
```

### **3. Update Logic**
```jsx
// Update existing expense
const updateExistingExpense = async (expense: any) => {
  // Update parent expense
  await supabase
    .from('project_expenses')
    .update({ description, amount, currency, expense_date })
    .eq('id', expense.id)
  
  // Delete existing child expenses
  await supabase
    .from('project_expenses')
    .delete()
    .eq('id_parent', expense.id)
  
  // Create new child expenses
  for (const [childObjectId, amountValue] of Object.entries(directObjectTotals)) {
    await supabase
      .from('project_expenses')
      .insert({
        id: crypto.randomUUID(),
        project_id: formData.project_id,
        description: `${formData.description} - ${childObjectName}`,
        expense_object_id: childObjectId,
        amount: amountValue,
        currency: formData.currency,
        expense_date: formData.expense_date,
        status: 'approved',
        employee_id: formData.employee_id,
        id_parent: expense.id,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        expense_object_columns: [childObjectId],
        invoice_items: []
      })
  }
}
```

## üìã **T√≥m t·∫Øt:**

**ƒê√£ th√™m:**
- ‚úÖ State management cho update functionality
- ‚úÖ Load existing expenses function
- ‚úÖ Load expense data for update function
- ‚úÖ Update existing expense function
- ‚úÖ UI components cho expense selection
- ‚úÖ Handle submit logic cho update mode

**K·∫øt qu·∫£:**
- ‚úÖ C√≥ th·ªÉ c·∫≠p nh·∫≠t chi ph√≠ ƒë√£ c√≥
- ‚úÖ UI ƒë·ªÉ ch·ªçn chi ph√≠ c·∫ßn c·∫≠p nh·∫≠t
- ‚úÖ Form ƒë∆∞·ª£c populate v·ªõi d·ªØ li·ªáu c≈©
- ‚úÖ Maintain parent-child relationship
- ‚úÖ User experience t·ªët

**Ch·ª©c nƒÉng c·∫≠p nh·∫≠t chi ph√≠ th·ª±c t·∫ø ƒë√£ ƒë∆∞·ª£c th√™m v·ªõi UI selector! üéØ**
